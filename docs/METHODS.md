# QPIè§£ææ‰‹æ³•ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç†è«–

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€QPIè§£æã§ä½¿ç”¨ã•ã‚Œã‚‹æ‰‹æ³•ãƒ»ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç†è«–çš„èƒŒæ™¯ã¨å®Ÿè£…ã®è©³ç´°ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

---

## ç›®æ¬¡

1. [QPIåŸºç¤ç†è«–](#1-qpiåŸºç¤ç†è«–)
2. [ä½“ç©æ¨å®šæ‰‹æ³•ã®æ¯”è¼ƒ](#2-ä½“ç©æ¨å®šæ‰‹æ³•ã®æ¯”è¼ƒ)
3. [Pomegranate 3Då†æ§‹æˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#3-pomegranate-3då†æ§‹æˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
4. [å›è»¢å¯¾ç§°ä½“ç©æ¨å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](#4-å›è»¢å¯¾ç§°ä½“ç©æ¨å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ )
5. [æ¥•å††ãƒ»Feretå¾„è¿‘ä¼¼](#5-æ¥•å††feretå¾„è¿‘ä¼¼)
6. [ç²¾åº¦å‘ä¸Šãƒ†ã‚¯ãƒ‹ãƒƒã‚¯](#6-ç²¾åº¦å‘ä¸Šãƒ†ã‚¯ãƒ‹ãƒƒã‚¯)

---

## 1. QPIåŸºç¤ç†è«–

### 1.1 ä½ç›¸å·®ã¨å…‰è·¯é•·å·®

å…‰ãŒç‰©è³ªã‚’é€éã™ã‚‹ã¨ã€ç‰©è³ªã®å±ˆæŠ˜ç‡ n ã«å¿œã˜ã¦ä½ç›¸ãŒå¤‰åŒ–ã™ã‚‹ã€‚çœŸç©ºï¼ˆã¾ãŸã¯ç©ºæ°—ã€nâ‚€ â‰ˆ 1ï¼‰ä¸­ã®å…‰ã¨æ¯”è¼ƒã—ãŸä½ç›¸å·® Ï† ã¯ä»¥ä¸‹ã§è¡¨ã•ã‚Œã‚‹ï¼š

```
Ï† = (2Ï€ / Î») Ã— OPD
```

ã“ã“ã§ï¼š
- Ï†: ä½ç›¸å·® [radians]
- Î»: å…‰ã®æ³¢é•· [m]
- OPD: å…‰è·¯é•·å·®ï¼ˆOptical Path Differenceï¼‰[m]

### 1.2 å…‰è·¯é•·å·®ã¨å±ˆæŠ˜ç‡

ã‚µãƒ³ãƒ—ãƒ«ã®åšã•ã‚’ dã€å±ˆæŠ˜ç‡ã‚’ n_sampleã€å‘¨å›²åª’è³ªï¼ˆåŸ¹åœ°ï¼‰ã®å±ˆæŠ˜ç‡ã‚’ n_medium ã¨ã™ã‚‹ã¨ï¼š

```
OPD = (n_sample - n_medium) Ã— d
```

ã“ã‚Œã‚ˆã‚Šï¼š

```
Ï† = (2Ï€ / Î») Ã— (n_sample - n_medium) Ã— d
```

### 1.3 å±ˆæŠ˜ç‡ï¼ˆRIï¼‰ã®è¨ˆç®—

ä¸Šå¼ã‚’ n_sample ã«ã¤ã„ã¦è§£ãã¨ï¼š

```
n_sample = n_medium + (Ï† Ã— Î») / (2Ï€ Ã— d)
```

**è¨˜å·ã®èª¬æ˜**ï¼š
- n_sample: ã‚µãƒ³ãƒ—ãƒ«ï¼ˆç´°èƒï¼‰ã®å±ˆæŠ˜ç‡ [ç„¡æ¬¡å…ƒ]
- n_medium: åŸ¹åœ°ã®å±ˆæŠ˜ç‡ [ç„¡æ¬¡å…ƒ]ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1.333ï¼‰
- Ï†: ä½ç›¸å·® [radians]
- Î»: ãƒ¬ãƒ¼ã‚¶ãƒ¼æ³¢é•· [m]ï¼ˆ663 nm = 663Ã—10â»â¹ mï¼‰
- d: ã‚µãƒ³ãƒ—ãƒ«ã®åšã¿ [m]

**å®Ÿè£…**:
```python
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
WAVELENGTH_NM = 663           # ãƒ¬ãƒ¼ã‚¶ãƒ¼æ³¢é•· [nm]
N_MEDIUM = 1.333              # åŸ¹åœ°ã®å±ˆæŠ˜ç‡
lambda_um = WAVELENGTH_NM / 1000  # æ³¢é•· [Âµm]

# RIè¨ˆç®—
ri_sample = N_MEDIUM + (phase_radians * lambda_um) / (2 * np.pi * thickness_um)
```

### 1.4 è³ªé‡æ¿ƒåº¦ã®è¨ˆç®—

ç´°èƒå†…ã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ¿ƒåº¦ C [mg/ml] ã¨å±ˆæŠ˜ç‡ n ã®é–“ã«ã¯ã€ä»¥ä¸‹ã®ç·šå½¢é–¢ä¿‚ãŒæˆã‚Šç«‹ã¤ï¼š

```
n - n_medium = Î± Ã— C
```

ã“ã“ã§ Î± ã¯**æ¯”å±ˆæŠ˜ç‡å¢—åˆ†**ï¼ˆSpecific Refractive Index Incrementï¼‰[ml/mg]ã€‚

ä¸Šå¼ã‚’ C ã«ã¤ã„ã¦è§£ãã¨ï¼š

```
C = (n - n_medium) / Î±
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ï¼š
- C: è³ªé‡æ¿ƒåº¦ [mg/ml]
- n: ã‚µãƒ³ãƒ—ãƒ«ã®å±ˆæŠ˜ç‡ [ç„¡æ¬¡å…ƒ]
- n_medium: åŸ¹åœ°ã®å±ˆæŠ˜ç‡ [ç„¡æ¬¡å…ƒ]
- Î±: æ¯”å±ˆæŠ˜ç‡å¢—åˆ† [ml/mg]ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.00018 ml/mgï¼‰

**å®Ÿè£…**:
```python
ALPHA_RI = 0.00018  # æ¯”å±ˆæŠ˜ç‡å¢—åˆ† [ml/mg]

# è³ªé‡æ¿ƒåº¦è¨ˆç®—
concentration_mg_ml = (ri_map - N_MEDIUM) / ALPHA_RI
```

### 1.5 Total Massã®è¨ˆç®—

ç´°èƒã®ç·è³ªé‡ã¯ã€å„ãƒ”ã‚¯ã‚»ãƒ«ã®è³ªé‡æ¿ƒåº¦ã¨ãã®ãƒ”ã‚¯ã‚»ãƒ«ã®ä½“ç©ã®ç©ã‚’å…¨ä½“ã§ç©ç®—ï¼š

```
M_total = Î£ C(x, y) Ã— V(x, y)
```

å˜ä½æ›ç®—ï¼š
```
1 mg/ml = 1 mg/cmÂ³ = 1 g/L = 10â¶ Âµg/cmÂ³ = 1 pg/ÂµmÂ³
```

ã‚ˆã£ã¦ï¼š
```
M_total [pg] = Î£ C [mg/ml] Ã— V [ÂµmÂ³]
```

**å®Ÿè£…**:
```python
# å„ãƒ”ã‚¯ã‚»ãƒ«ã®ä½“ç©
pixel_volumes = thickness_um[mask] * pixel_area_um2  # [ÂµmÂ³]

# Total massè¨ˆç®—
total_mass_pg = np.sum(concentration_map[mask] * pixel_volumes)  # [pg]
```

### 1.6 ä½¿ç”¨ã—ãŸä»®å®š

#### å…‰å­¦çš„ä»®å®š

1. **è–„ã„ç‰©ä½“è¿‘ä¼¼ï¼ˆThin Object Approximationï¼‰**
   - å…‰ãŒã‚µãƒ³ãƒ—ãƒ«ã‚’ç›´é€²é€éã™ã‚‹
   - å›æŠ˜ãƒ»æ•£ä¹±ã®å½±éŸ¿ã¯ç„¡è¦–

2. **å‡è³ªãªåŸ¹åœ°**
   - åŸ¹åœ°ã®å±ˆæŠ˜ç‡ n_medium ã¯ä¸€å®šï¼ˆ1.333ï¼‰
   - æ¸©åº¦ãƒ»æ¿ƒåº¦å¤‰åŒ–ã¯ç„¡è¦–

3. **ç·šå½¢å¿œç­”**
   - ä½ç›¸å·®ã¨å…‰è·¯é•·å·®ãŒç·šå½¢é–¢ä¿‚
   - é«˜æ¬¡ã®éç·šå½¢åŠ¹æœã¯ç„¡è¦–

#### ç”Ÿç‰©å­¦çš„ä»®å®š

1. **æ¯”å±ˆæŠ˜ç‡å¢—åˆ†ã®ä¸€å®šæ€§**
   - ç´°èƒå†…ã®ã™ã¹ã¦ã®é ˜åŸŸã§ Î± = 0.00018 ml/mg
   - ã‚¿ãƒ³ãƒ‘ã‚¯è³ªçµ„æˆã®é•ã„ã¯ç„¡è¦–

2. **2DæŠ•å½±ã‹ã‚‰ã®3Då†æ§‹æˆ**
   - æ¥•å††è¿‘ä¼¼ã€Feretå¾„è¿‘ä¼¼ã€å›è»¢å¯¾ç§°ãªã©ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
   - å®Ÿéš›ã®å½¢çŠ¶ã‹ã‚‰ã®ãšã‚Œã¯èª¤å·®è¦å› 

### 1.7 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | è¨˜å· | å€¤ | å˜ä½ | èª¬æ˜ |
|-----------|------|-----|------|------|
| ãƒ¬ãƒ¼ã‚¶ãƒ¼æ³¢é•· | Î» | 663 | nm | ã‚ªãƒ•ã‚¢ã‚¯ã‚·ã‚¹ãƒ›ãƒ­ã‚°ãƒ©ãƒ•ã‚£ãƒ¼ç”¨å…‰æº |
| åŸ¹åœ°å±ˆæŠ˜ç‡ | n_medium | 1.333 | - | åŸ¹åœ°ï¼ˆä¸»ã«æ°´ï¼‰ã®å±ˆæŠ˜ç‡ |
| ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º | - | 0.348 | Âµm | 507Ã—507å†æ§‹æˆç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º |
| æ¯”å±ˆæŠ˜ç‡å¢—åˆ† | Î± | 0.00018 | ml/mg | ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã®æ¨™æº–å€¤ |

---

## 2. ä½“ç©æ¨å®šæ‰‹æ³•ã®æ¯”è¼ƒ

### 2.1 æ‰‹æ³•ã®æ¦‚è¦

| æ‰‹æ³• | åŸç† | ç‰¹å¾´ | ç²¾åº¦ | é€Ÿåº¦ |
|------|------|------|------|------|
| **æ¥•å††è¿‘ä¼¼** | ROIã‚’æ¥•å††è¿‘ä¼¼ã—ã€å›è»¢æ¥•å††ä½“ã¨ã—ã¦ä½“ç©è¨ˆç®— | ã‚·ãƒ³ãƒ—ãƒ« | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… |
| **Feretå¾„è¿‘ä¼¼** | Feretå¾„ã§å½¢çŠ¶ã‚’è¿‘ä¼¼ | ç´°é•·ã„ç´°èƒã«å¼·ã„ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| **Pomegranate** | Distance Transform + çƒä½“å±•é–‹ | è¤‡é›‘ãªå½¢çŠ¶ã«å¯¾å¿œ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| **å›è»¢å¯¾ç§°** | åå¾©çš„ä¸­å¿ƒç·šãƒ»æ–­é¢ç·šæ›´æ–° | è«–æ–‡æº–æ‹ ã€é«˜ç²¾åº¦ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜†â˜†â˜† |

### 2.2 é©ç”¨å ´é¢

**æ¥•å††è¿‘ä¼¼**:
- âœ… æ¥•å††å½¢ã«è¿‘ã„ç´°èƒ
- âœ… é«˜é€Ÿå‡¦ç†ãŒå¿…è¦ãªå ´åˆ
- âŒ ç´°é•·ã„ç´°èƒã€ä¸è¦å‰‡ãªå½¢çŠ¶

**Feretå¾„è¿‘ä¼¼**:
- âœ… ç´°é•·ã„ç´°èƒï¼ˆåˆ†è£‚é…µæ¯ãªã©ï¼‰
- âœ… æ¥•å††è¿‘ä¼¼ã§ç²¾åº¦ãŒä½ã„å ´åˆ
- âŒ è¤‡é›‘ãªå½¢çŠ¶

**Pomegranate**:
- âœ… è¤‡é›‘ãªå½¢çŠ¶ï¼ˆåˆ†å²ã€ä¸è¦å‰‡ï¼‰
- âœ… 2Dç”»åƒã‹ã‚‰3Då†æ§‹æˆ
- âŒ XY/Zè§£åƒåº¦ãŒå¤§ããç•°ãªã‚‹å ´åˆ

**å›è»¢å¯¾ç§°**:
- âœ… å›è»¢å¯¾ç§°ã«è¿‘ã„ç´°èƒ
- âœ… è«–æ–‡æº–æ‹ ã®è§£æãŒå¿…è¦ãªå ´åˆ
- âœ… é«˜ç²¾åº¦ãŒå¿…è¦ãªå ´åˆ
- âŒ é«˜é€Ÿå‡¦ç†ãŒå¿…è¦ãªå ´åˆ

---

## 3. Pomegranate 3Då†æ§‹æˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 3.1 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ ¸å¿ƒ

Pomegranateã¯ã€**2Dã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã‹ã‚‰3Då½¢çŠ¶ã‚’å†æ§‹æˆ**ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚Distance Transformã€SkeletonåŒ–ã€çƒä½“æ–­é¢è¨ˆç®—ã‚’çµ„ã¿åˆã‚ã›ãŸæ‰‹æ³•ã«ã‚ˆã‚Šã€è¤‡é›‘ãªç´°èƒå½¢çŠ¶ã‚’3Dã§å¾©å…ƒã—ã¾ã™ã€‚

### 3.2 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®4ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—

#### Step 1: Distance Transform (è·é›¢å¤‰æ›)

å„å‰æ™¯ãƒ”ã‚¯ã‚»ãƒ«ã‹ã‚‰**æœ€ã‚‚è¿‘ã„èƒŒæ™¯ãƒ”ã‚¯ã‚»ãƒ«ã¾ã§ã®è·é›¢**ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

```
å…ƒã®ãƒã‚¤ãƒŠãƒªç”»åƒ:
â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ
â–ˆ â–‘ â–‘ â–‘ â–ˆ
â–ˆ â–‘ â–‘ â–‘ â–ˆ
â–ˆ â–‘ â–‘ â–‘ â–ˆ
â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ

Distance Map (æ•°å€¤ã¯è·é›¢):
â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ
â–ˆ 1 1 1 â–ˆ
â–ˆ 1 2 1 â–ˆ
â–ˆ 1 1 1 â–ˆ
â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ
```

**æ„å‘³**:
- Distanceå€¤ = ãã®ä½ç½®ã§ã®ã€Œå±€æ‰€çš„ãªåŠå¾„ã€
- ç‰©ä½“ã®ä¸­å¿ƒã«è¿‘ã„ã»ã©å€¤ãŒå¤§ãã„
- ç´°ã„éƒ¨åˆ†ã¯å°ã•ãã€å¤ªã„éƒ¨åˆ†ã¯å¤§ãããªã‚‹

**æ•°å¼**:
```
D(p) = min{||p - q|| : q âˆˆ Background}
```

**å®Ÿè£…**:
```python
from scipy import ndimage
distance_map = ndimage.distance_transform_edt(binary_image)
```

#### Step 2: Skeleton (éª¨æ ¼åŒ–)

ç‰©ä½“ã‚’**1ãƒ”ã‚¯ã‚»ãƒ«å¹…ã®ä¸­å¿ƒç·š**ã¾ã§ç´°ç·šåŒ–ã—ã¾ã™ã€‚

```
å…ƒã®ãƒã‚¤ãƒŠãƒªç”»åƒ:
â–‘ â–ˆ â–ˆ â–ˆ â–‘
â–‘ â–ˆ â–ˆ â–ˆ â–‘
â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ
â–‘ â–ˆ â–ˆ â–ˆ â–‘
â–‘ â–‘ â–ˆ â–‘ â–‘

Skeleton:
â–‘ â–‘ â–ˆ â–‘ â–‘
â–‘ â–‘ â–ˆ â–‘ â–‘
â–‘ â–ˆ â–ˆ â–ˆ â–‘
â–‘ â–‘ â–ˆ â–‘ â–‘
â–‘ â–‘ â–ˆ â–‘ â–‘
```

**æ„å‘³**:
- ç‰©ä½“ã®ã€ŒèƒŒéª¨ã€ã‚’æŠ½å‡º
- å½¢çŠ¶ã®ãƒˆãƒãƒ­ã‚¸ãƒ¼ã‚’ä¿æŒ
- åŒã˜é ˜åŸŸã‚’è¤‡æ•°å›å‡¦ç†ã™ã‚‹ã“ã¨ã‚’é˜²ã

**å®Ÿè£…**:
```python
from skimage import morphology
skeleton = morphology.skeletonize(binary_image)
```

#### Step 3: Medial Axis Transform

**Skeleton ã¨ Distance Map ã‚’çµ„ã¿åˆã‚ã›ã‚‹**ã“ã¨ã§ã€ä¸­å¿ƒè»¸ãƒ”ã‚¯ã‚»ãƒ«ã«åŠå¾„æƒ…å ±ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```
Medial Axis Transform = Skeleton Ã— Distance Map
```

**æ„å‘³**:
å„ä¸­å¿ƒè»¸ãƒ”ã‚¯ã‚»ãƒ«ãŒæŒã¤æƒ…å ±:
- ã€Œã“ã®ä½ç½®ã‹ã‚‰åŠå¾„Rã®çƒä½“ã‚’æãã€
- R = Medial Axiså€¤ + æ‹¡å¼µãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**å®Ÿè£…**:
```python
medial_axis = skeleton * distance_map
```

#### Step 4: 3D Reconstruction via Spherical Expansion

å„ä¸­å¿ƒè»¸ãƒ”ã‚¯ã‚»ãƒ«ã‹ã‚‰**çƒä½“ã‚’ä¸Šä¸‹ã«å±•é–‹**ã—ã¾ã™ã€‚

**çƒä½“ã®æ–­é¢åŠå¾„è¨ˆç®—**:

çƒã®æ–¹ç¨‹å¼ã‹ã‚‰å°å‡º:
```
xÂ² + yÂ² + zÂ² = RÂ²
```

zå¹³é¢ã§åˆ‡æ–­ã™ã‚‹ã¨:
```
xÂ² + yÂ² = RÂ² - zÂ²
```

ã—ãŸãŒã£ã¦ã€æ–­é¢åŠå¾„:
```
r(z) = âˆš(RÂ² - zÂ²)
```

**è¦–è¦šåŒ–**:
```
        z
        â†‘
        |     â—  â† Râ‚€ = 10 px
        |    â•±â”‚â•²
   z=+2 |   â—â”€â”¼â”€â—  â† r(2) = âˆš(100-4) â‰ˆ 9.8
        |  â•±  â”‚  â•²
   z=0  | â—â”€â”€â”€â”¼â”€â”€â”€â—  â† r(0) = 10
        |  â•²  â”‚  â•±
   z=-2 |   â—â”€â”¼â”€â—  â† r(-2) â‰ˆ 9.8
        |    â•²â”‚â•±
        |     â—
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ xyå¹³é¢
```

**å®Ÿè£…**:
```python
def reconstruct_3d(medial_axis, n_slices, mid_slice, elongation_factor):
    stack_3d = np.zeros((n_slices, height, width))
    
    for y, x in np.argwhere(skeleton):
        r0 = medial_axis[y, x] + radius_enlarge
        
        for z in range(n_slices):
            z_distance = (mid_slice - z) / elongation_factor
            r_squared = r0**2 - z_distance**2
            
            if r_squared > 0:
                segment_radius = np.sqrt(r_squared)
                rr, cc = morphology.disk(int(segment_radius))
                rr, cc = rr + y, cc + x
                stack_3d[z, rr, cc] = 255
    
    return stack_3d
```

### 3.3 Zæ–¹å‘ã®ã‚¹ãƒ©ã‚¤ã‚¹æ•°ã®è‡ªå‹•æ¨å®š

```python
max_distance = np.max(distance_map)
elongation_factor = voxel_xy / voxel_z
z_slices = 2 * (ceil(max_distance * elongation_factor) + 2)
```

**ç†è«–çš„æ ¹æ‹ **:
1. æœ€å¤§Distanceå€¤ = ç‰©ä½“ã®æœ€å¤§åŠå¾„ï¼ˆpixelsï¼‰
2. Zæ–¹å‘ã®ç¯„å›² = æœ€å¤§åŠå¾„ Ã— elongation_factorï¼ˆslicesï¼‰
3. ç›´å¾„åˆ†ãªã®ã§ Ã—2
4. ãƒãƒƒãƒ•ã‚¡ã¨ã—ã¦ +2 ã‚¹ãƒ©ã‚¤ã‚¹

**ä¾‹**:
- æœ€å¤§åŠå¾„: 20 px
- voxel_XY: 0.1 Âµm
- voxel_Z: 0.3 Âµm
- elongation: 0.333
- Z slices: 2 Ã— (7 + 2) = 18

### 3.4 Elongation Factorï¼ˆZæ–¹å‘ã®è·é›¢è£œæ­£ï¼‰

XYã¨Zã®è§£åƒåº¦ãŒç•°ãªã‚‹å ´åˆã€**Elongation Factor**ã§è£œæ­£:

```
elongation_factor = voxel_XY / voxel_Z
```

å®Ÿéš›ã®Zè·é›¢:
```
z_real = (z_slice - z_mid) / elongation_factor
```

### 3.5 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åˆ©ç‚¹

1. **å½¢çŠ¶ã«ä¾å­˜ã—ãªã„**
   - æ¥•å††ã€ä¸è¦å‰‡å½¢çŠ¶ã€è¤‡æ•°ã®çªèµ·ã«ã‚‚å¯¾å¿œ

2. **è§£åƒåº¦ã®ç•°æ–¹æ€§ã«å¯¾å¿œ**
   - Elongation factorã§è‡ªå‹•è£œæ­£

3. **è¨ˆç®—åŠ¹ç‡ãŒè‰¯ã„**
   - Skeletonã«ã‚ˆã‚Šå‡¦ç†ãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’å‰Šæ¸›

4. **ç‰©ç†çš„ã«å¦¥å½“**
   - çƒä½“è¿‘ä¼¼ã¯ç´°èƒå½¢çŠ¶ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«

### 3.6 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åˆ¶é™äº‹é …

1. **çƒä½“è¿‘ä¼¼ãŒå‰æ**
   - å‡¹å‡¸ã®æ¿€ã—ã„å½¢çŠ¶ã§ã¯ç²¾åº¦ä½ä¸‹

2. **è–„ã„æ§‹é€ ã®éå°è©•ä¾¡**
   - éå¸¸ã«è–„ã„/é•·ã„çªèµ·ã¯å†ç¾ã—ã«ãã„

3. **é‡ãªã‚Šåˆã†æ§‹é€ **
   - è¤‡æ•°ã®ç‰©ä½“ãŒæ¥è§¦ã—ã¦ã„ã‚‹å ´åˆã€åˆ†é›¢å›°é›£

---

## 4. å›è»¢å¯¾ç§°ä½“ç©æ¨å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 4.1 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŸç†

Odermatt et al. (2021) eLife 10:e64901 ã«åŸºã¥ãå®Ÿè£…ã€‚

è«–æ–‡ã‹ã‚‰ã®å¼•ç”¨ï¼š
> "Each cell outline was skeletonized using custom Matlab code as follows. First, the closest-fitting rectangle around each cell was used to define the long axis of the cell. Perpendicular to the long axis, sectioning lines at 250 nm intervals and their intersection with the cell contour were computed. The centerline was then updated to run through the midpoint of each sectioning line between the two contour-intersection points."

### 4.2 ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ ¸å¿ƒã‚¹ãƒ†ãƒƒãƒ—

1. **é•·è»¸ã®æ±ºå®š**: æœ€å°å¤–æ¥çŸ©å½¢
2. **æ–­é¢ç·šã®é…ç½®**: é•·è»¸ã«å‚ç›´ã€250nmé–“éš”
3. **åå¾©çš„æ›´æ–°**:
   - å„æ–­é¢ç·šã¨è¼ªéƒ­ã®äº¤ç‚¹ã‚’è¨ˆç®—
   - äº¤ç‚¹ã®ä¸­ç‚¹ã‚’é€šã‚‹ã‚ˆã†ã«ä¸­å¿ƒç·šã‚’æ›´æ–°
   - ä¸­å¿ƒç·šã®å±€æ‰€çš„ãªå‚¾ãã«å‚ç›´ã«ãªã‚‹ã‚ˆã†ã«æ–­é¢ç·šã‚’æ›´æ–°
4. **ä½“ç©è¨ˆç®—**: å„æ–­é¢ã‚’å††å½¢ã¨ä»®å®šã—ã¦å›è»¢å¯¾ç§°ä½“ç©ã‚’è¨ˆç®—

### 4.3 åå¾©çš„æ›´æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```python
for iteration in range(max_iterations):
    # 1. å„æ–­é¢ç·šã¨è¼ªéƒ­ã®äº¤ç‚¹ã‚’è¨ˆç®—
    for i in range(n_sections):
        intersections = find_intersections(section_line, contour)
        midpoint = (p1 + p2) / 2
        
    # 2. äº¤ç‚¹ã®ä¸­ç‚¹ã‚’é€šã‚‹ã‚ˆã†ã«ä¸­å¿ƒç·šã‚’æ›´æ–°
    new_centerline = interpolate(midpoints)
    
    # 3. ä¸­å¿ƒç·šã®å±€æ‰€çš„ãªå‚¾ãã«å‚ç›´ã«ãªã‚‹ã‚ˆã†ã«æ–­é¢ç·šã‚’æ›´æ–°
    for i in range(n_sections):
        tangent = new_centerline[i] - new_centerline[i-1]
        perpendicular_angle = arctan2(tangent) + Ï€/2
        update_section_line(i, perpendicular_angle)
    
    # 4. åæŸåˆ¤å®š
    mean_shift = np.mean(np.linalg.norm(new_centerline - old_centerline, axis=1))
    if mean_shift < convergence_tolerance:
        break
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `max_iterations`: æœ€å¤§åå¾©å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰
- `convergence_tolerance`: åæŸé–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.5ãƒ”ã‚¯ã‚»ãƒ«ï¼‰

### 4.4 ä½“ç©è¨ˆç®—

å„æ–­é¢ã‚’å††å½¢ã¨ä»®å®šã—ã¦ä½“ç©ã‚’è¨ˆç®—ï¼š

```python
# å„æ–­é¢ã®åŠå¾„ã‚’è¨ˆç®—
for i in range(n_sections):
    radius[i] = distance(p1, p2) / 2

# ä½“ç©è¨ˆç®—ï¼ˆå††æŸ±ã®å’Œï¼‰
total_volume = sum(Ï€ * rÂ² * h for r in radii)
volume_um3 = total_volume * (pixel_size_um ** 3)
```

### 4.5 Z-stackåšã¿ãƒãƒƒãƒ—ç”Ÿæˆ

å„XYãƒ”ã‚¯ã‚»ãƒ«ä½ç½®ã§ã®Zæ–¹å‘ã®åšã¿ï¼ˆã‚¹ãƒ©ã‚¤ã‚¹æ•°ï¼‰ã‚’è¨ˆç®—ï¼š

```python
# å›è»¢å¯¾ç§°ã‚’ä»®å®š
for center, radius in zip(centerline_points, radii):
    # çƒä½“ã®æ–­é¢: z = 2*sqrt(RÂ² - rÂ²)
    for y in range(height):
        for x in range(width):
            dist_from_center = distance((x, y), center)
            if dist_from_center <= radius:
                z_at_r = 2 * sqrt(radiusÂ² - dist_from_centerÂ²)
                thickness_map[y, x] = max(thickness_map[y, x], z_at_r)
```

### 4.6 å®Ÿè£…ã®è©³ç´°

**é•·è»¸ã®æ±ºå®š**:
```python
rect = cv2.minAreaRect(contour.astype(np.float32))
center, size, angle = rect
```

**æ–­é¢ç·šã®é…ç½®**:
```python
n_sections = int(axis_length / section_interval_px)
t = np.linspace(0, 1, n_sections)
section_centers = axis_start + t * (axis_end - axis_start)
```

---

## 5. æ¥•å††ãƒ»Feretå¾„è¿‘ä¼¼

### 5.1 æ¥•å††è¿‘ä¼¼

#### åŸç†
ROIã‚’æ¥•å††ã§è¿‘ä¼¼ã—ã€3Då½¢çŠ¶ã‚’ã€Œå††æŸ± + ä¸¡ç«¯ã®åŠçƒã€ã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«åŒ–ï¼š

```
       åŠçƒ    å††æŸ±éƒ¨    åŠçƒ
        _______________
       /               \
      |                 |
      |                 |
       \_______________ /

      â† r â†’â† h â†’â† r â†’
```

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ï¼š
- r: åŠå¾„ = Minor / 2
- h: å††æŸ±éƒ¨ã®é•·ã• = Major - 2r
- Major, Minor: ImageJã®ROIæ¥•å††è¿‘ä¼¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

#### ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã®åšã¿è¨ˆç®—

å„ãƒ”ã‚¯ã‚»ãƒ« (x, y) ã«ã¤ã„ã¦ã€zæ–¹å‘ã®åšã¿ d(x, y) ã‚’å¹¾ä½•å­¦çš„ã«è¨ˆç®—ï¼š

**å††æŸ±éƒ¨åˆ†**:
```
d(x, y) = 2 Ã— sqrt(rÂ² - ÏÂ²)
```

**åŠçƒéƒ¨åˆ†**:
```
d(x, y) = 2 Ã— sqrt(rÂ² - sÂ²)
```

#### ä½“ç©ã®æ•°å€¤ç©åˆ†

```
V = Î£ d(x, y) Ã— A_pixel
```

**å®Ÿè£…**:
```python
PIXEL_SIZE_UM = 0.348  # ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚º [Âµm]
pixel_area_um2 = PIXEL_SIZE_UM ** 2  # [ÂµmÂ²]

# ãƒã‚¹ã‚¯å†…ã®ãƒ”ã‚¯ã‚»ãƒ«ã«ã¤ã„ã¦ç©ç®—
mask = (zstack_map > 0)
volume_um3 = np.sum(zstack_map[mask] * pixel_area_um2)
```

### 5.2 Feretå¾„è¿‘ä¼¼

#### åŸç†
Feretå¾„ï¼ˆFeret diameterï¼‰ï¼šç‰©ä½“ã®æœ€å¤§å¹…ã¨æœ€å°å¹…ã‚’ä½¿ç”¨ã€‚

**Feretå¾„ã®å®šç¾©**:
- Major Feret: æœ€å¤§å¹…
- Minor Feret: æœ€å°å¹…ï¼ˆMajor Feretã«å‚ç›´ãªæ–¹å‘ï¼‰

#### å®Ÿè£…
```python
def create_feret_mask(self, width, height, major, minor, angle, cx, cy):
    """Feretå¾„ã«åŸºã¥ã3Då½¢çŠ¶è¿‘ä¼¼"""
    # å›è»¢è¡Œåˆ—
    cos_a, sin_a = np.cos(angle), np.sin(angle)
    
    # è»¸æ–¹å‘ã®è·é›¢è¨ˆç®—
    dist_major = abs((px - cx) * cos_a + (py - cy) * sin_a)
    dist_minor = abs(-(px - cx) * sin_a + (py - cy) * cos_a)
    
    # æ¥•å††å†…åˆ¤å®š
    in_ellipse = (dist_major / half_major)**2 + (dist_minor / half_minor)**2 <= 1
    
    # åšã¿è¨ˆç®—
    # ...
```

#### é©ç”¨å ´é¢
- âœ… ç´°é•·ã„ç´°èƒï¼ˆåˆ†è£‚é…µæ¯ãªã©ï¼‰
- âœ… æ¥•å††è¿‘ä¼¼ã§ç²¾åº¦ãŒä½ã„å ´åˆ
- âŒ è¤‡é›‘ãªå½¢çŠ¶

---

## 6. ç²¾åº¦å‘ä¸Šãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

### 6.1 ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°

#### åŸç†
å„ãƒ”ã‚¯ã‚»ãƒ«ã‚’NÃ—Nã®ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã«åˆ†å‰²ã—ã¦ç²¾åº¦å‘ä¸Šã€‚

#### å®Ÿè£…
```python
# ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—
offsets = np.linspace(0.5/N, 1 - 0.5/N, N) - 0.5

# å„ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã§åšã¿ã‚’è¨ˆç®—ã—å¹³å‡
for dy_offset in offsets:
    for dx_offset in offsets:
        px_sub = px + 0.5 + dx_offset
        py_sub = py + 0.5 + dy_offset
        # åšã¿è¨ˆç®—...
        
thickness_pixel = thickness_sum / valid_subpixels
```

#### æ¨å¥¨è¨­å®š
- N=1: é«˜é€Ÿï¼ˆãƒ”ã‚¯ã‚»ãƒ«ä¸­å¿ƒã®ã¿ï¼‰
- N=5: æ¨å¥¨ï¼ˆç²¾åº¦ã¨é€Ÿåº¦ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
- N=10: æœ€é«˜ç²¾åº¦

#### åŠ¹æœ
- 2-5%ã®ç²¾åº¦å‘ä¸Š
- å®Ÿè¡Œæ™‚é–“ã¯ç´„NÂ²å€

### 6.2 èƒŒæ™¯è£œæ­£

ä½ç›¸å·®ç”»åƒã®èƒŒæ™¯ã‚’è£œæ­£ï¼š

```python
# 1æšç›®ã®ç”»åƒã‚’å…¨ä½“ã‹ã‚‰æ¸›ç®—
background = phase_images[0]
corrected_phases = phase_images - background
```

### 6.3 ROIã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°

ImageJã§ROIã‚’å‰å‡¦ç†ï¼š

```imagej
// Gap Closure & Smoothing
run("Enlarge...", "enlarge=" + gap + " pixel");
run("Enlarge...", "enlarge=-" + gap + " pixel");
```

åŠ¹æœï¼š
- å°ã•ãªç©´ã‚„å‡¹ã¿ã‚’åŸ‹ã‚ã‚‹
- æ»‘ã‚‰ã‹ãªè¼ªéƒ­

---

## ğŸ“Š è¨ˆç®—ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚ªãƒ•ã‚¢ã‚¯ã‚·ã‚¹        â”‚
â”‚ ãƒ›ãƒ­ã‚°ãƒ©ãƒ ç”»åƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FFTã«ã‚ˆã‚‹ä½ç›¸å†æ§‹æˆ â”‚
â”‚ â†’ ä½ç›¸å·® Ï† [rad]    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROIæ¤œå‡º             â”‚
â”‚ (Omnipose)          â”‚
â”‚ â†’ Major, Minor, Î¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½“ç©æ¨å®šæ‰‹æ³•é¸æŠ    â”‚
â”‚ (4ã¤ã‹ã‚‰é¸æŠ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                      â”‚
       â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RIè¨ˆç®—       â”‚      â”‚ ä½“ç©è¨ˆç®—      â”‚
â”‚ n = nâ‚€ +     â”‚      â”‚ V = Î£(dÂ·A)    â”‚
â”‚  (Ï†Î»)/(2Ï€d)  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
       â”‚                      â”‚
       â–¼                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ è³ªé‡æ¿ƒåº¦è¨ˆç®— â”‚              â”‚
â”‚ C = (n-nâ‚€)/Î± â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
       â”‚                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Total Massè¨ˆç®— â”‚
         â”‚ M = Î£(CÂ·V)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

### ä¸»è¦è«–æ–‡

1. **Odermatt, P. D., et al. (2021)**  
   "Variations of intracellular density during the cell cycle arise from tip-growth regulation in fission yeast."  
   *eLife*, 10, e64901.  
   https://doi.org/10.7554/eLife.64901

2. **Park, Y., Depeursinge, C. & Popescu, G. (2018)**  
   "Quantitative phase imaging in biomedicine."  
   *Nature Photonics*, 12, 578â€“589.  
   https://doi.org/10.1038/s41566-018-0253-x

3. **Barer, R. & Joseph, S. (1954)**  
   "Refractometry of living cells."  
   *Quarterly Journal of Microscopical Science*, 95, 399-423.

4. **Popescu, G. (2011)**  
   "Quantitative Phase Imaging of Cells and Tissues."  
   McGraw-Hill Education.

5. **Mir, M. et al. (2011)**  
   "Optical measurement of cycle-dependent cell growth."  
   *Proceedings of the National Academy of Sciences*, 108, 13124-13129.

### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢

6. **Pomegranate**  
   Baybay, E. K. D. (2020). Pomegranate: 3D Cell Segmentation Pipeline.  
   Virginia Tech, Hauf Lab.

7. **Omnipose**  
   Cutler, K. J., et al. (2022). "Omnipose: a high-precision morphology-independent solution for bacterial cell segmentation."  
   *Nature Methods*, 19, 1438-1448.

8. **Felzenszwalb, P. F., & Huttenlocher, D. P. (2012)**  
   "Distance transforms of sampled functions."  
   Theory of Computing, 8(1), 415-428.

9. **Zhang, T. Y., & Suen, C. Y. (1984)**  
   "A fast parallel algorithm for thinning digital patterns."  
   Communications of the ACM, 27(3), 236-239.

---

**æœ€çµ‚æ›´æ–°**: 2025-12-24  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: QPI_omni  
**è‘—è€…**: AI Assistant

