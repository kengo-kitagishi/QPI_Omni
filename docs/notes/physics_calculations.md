# QPI解析における物理量計算の原理と計算式

## 目次

1. [QPI（定量位相イメージング）の基本原理](#1-qpi定量位相イメージングの基本原理)
2. [屈折率（RI）の計算](#2-屈折率riの計算)
3. [質量濃度の計算](#3-質量濃度の計算)
4. [体積の計算](#4-体積の計算)
5. [Total Massの計算](#5-total-massの計算)
6. [使用した仮定](#6-使用した仮定)
7. [パラメータ一覧](#7-パラメータ一覧)
8. [参考文献](#8-参考文献)

---

## 1. QPI（定量位相イメージング）の基本原理

### 1.1 位相差と光路長差

光が物質を透過すると、物質の屈折率 \( n \) に応じて位相が変化する。真空（または空気、\( n_0 \approx 1 \)）中の光と比較した位相差 \( \phi \) は以下で表される：

```
φ = (2π / λ) × OPD
```

ここで：
- \( \phi \): 位相差 [radians]
- \( \lambda \): 光の波長 [m]
- \( OPD \): 光路長差（Optical Path Difference）[m]

### 1.2 光路長差と屈折率

サンプルの厚さを \( d \)、屈折率を \( n_{\text{sample}} \)、周囲媒質（培地）の屈折率を \( n_{\text{medium}} \) とすると：

```
OPD = (n_sample - n_medium) × d
```

これより：

```
φ = (2π / λ) × (n_sample - n_medium) × d
```

---

## 2. 屈折率（RI）の計算

### 2.1 基本式

上式を \( n_{\text{sample}} \) について解くと：

```
n_sample = n_medium + (φ × λ) / (2π × d)
```

**記号の説明**：
- \( n_{\text{sample}} \): サンプル（細胞）の屈折率 [無次元]
- \( n_{\text{medium}} \): 培地の屈折率 [無次元]（デフォルト: 1.333）
- \( \phi \): 位相差 [radians]
- \( \lambda \): レーザー波長 [m]（663 nm = 663×10⁻⁹ m）
- \( d \): サンプルの厚み [m]

### 2.2 実装における計算

Pythonコードでは、以下のように実装：

```python
# パラメータ
WAVELENGTH_NM = 663           # レーザー波長 [nm]
N_MEDIUM = 1.333              # 培地の屈折率
lambda_um = WAVELENGTH_NM / 1000  # 波長 [µm]

# RI計算
ri_sample = N_MEDIUM + (phase_radians * lambda_um) / (2 * np.pi * thickness_um)
```

### 2.3 物理的意味

- **培地補正**: \( n_{\text{medium}} \) を加算することで、培地を基準とした相対的な屈折率変化を絶対値に変換
- **厚み依存性**: 同じ位相差でも、厚みが大きいほど屈折率は小さい（光路長差が同じ場合）

---

## 3. 質量濃度の計算

### 3.1 比屈折率増分（Specific Refractive Index Increment）

細胞内のタンパク質濃度 \( C \) [mg/ml] と屈折率 \( n \) の間には、以下の線形関係が成り立つ：

```
n - n_medium = α × C
```

ここで \( \alpha \) は**比屈折率増分**（Specific Refractive Index Increment）[ml/mg]。

### 3.2 質量濃度の計算式

上式を \( C \) について解くと：

```
C = (n - n_medium) / α
```

**記号の説明**：
- \( C \): 質量濃度 [mg/ml]
- \( n \): サンプルの屈折率 [無次元]
- \( n_{\text{medium}} \): 培地の屈折率 [無次元]
- \( \alpha \): 比屈折率増分 [ml/mg]（デフォルト: 0.00018 ml/mg）

### 3.3 実装

```python
ALPHA_RI = 0.00018  # 比屈折率増分 [ml/mg]

# 質量濃度計算
concentration_mg_ml = (ri_map - N_MEDIUM) / ALPHA_RI
```

### 3.4 比屈折率増分の典型値

| 物質 | α [ml/mg] | 参考 |
|------|-----------|------|
| タンパク質（一般） | 0.00018 - 0.00020 | Barer & Joseph (1954) |
| BSA（ウシ血清アルブミン） | 0.00185 | 標準値 |
| 細胞質（平均） | ~0.00018 | 本解析で使用 |

---

## 4. 体積の計算

### 4.1 Rod-shaped細胞の3D形状モデル

細胞を「円柱 + 両端の半球」としてモデル化：

```
       半球    円柱部    半球
        _______________
       /               \
      |                 |
      |                 |
       \_______________ /

      ← r →← h →← r →
```

**パラメータ**：
- \( r \): 半径 = Minor / 2
- \( h \): 円柱部の長さ = Major - 2r
- Major, Minor: ImageJのROI楕円近似パラメータ

### 4.2 ピクセルごとの厚み計算

各ピクセル \((x, y)\) について、z方向の厚み \( d(x, y) \) を幾何学的に計算：

#### 円柱部分
軸からの距離 \( \rho \) が \( r \) 以下の場合：

```
d(x, y) = 2 × sqrt(r² - ρ²)
```

#### 半球部分
球面からの距離 \( s \) が \( r \) 以下の場合：

```
d(x, y) = 2 × sqrt(r² - s²)
```

### 4.3 体積の数値積分

ピクセル面積を \( A_{\text{pixel}} \) [µm²] とすると、体積 \( V \) は：

```
V = Σ d(x, y) × A_pixel
```

各ピクセルが直方体の体積に対応。

### 4.4 実装

```python
PIXEL_SIZE_UM = 0.348  # ピクセルサイズ [µm]
pixel_area_um2 = PIXEL_SIZE_UM ** 2  # [µm²]

# マスク内のピクセルについて積算
mask = (zstack_map > 0)
volume_um3 = np.sum(zstack_map[mask] * pixel_area_um2)
```

### 4.5 サブピクセルサンプリング（精度向上）

ピクセル境界での精度を向上させるため、各ピクセルを \( N \times N \) のサブピクセルに分割：

```python
# サブピクセルオフセット計算
offsets = np.linspace(0.5/N, 1 - 0.5/N, N) - 0.5

# 各サブピクセルで厚みを計算し平均
for dy_offset in offsets:
    for dx_offset in offsets:
        px_sub = px + 0.5 + dx_offset
        py_sub = py + 0.5 + dy_offset
        # 厚み計算...
        
thickness_pixel = thickness_sum / valid_subpixels
```

**推奨設定**：
- \( N = 1 \): 高速（ピクセル中心のみ）
- \( N = 5 \): 推奨（精度と速度のバランス）
- \( N = 10 \): 最高精度

---

## 5. Total Massの計算

### 5.1 基本原理

細胞の総質量は、各ピクセルの質量濃度とそのピクセルの体積の積を全体で積算：

```
M_total = Σ C(x, y) × V(x, y)
```

### 5.2 単位変換

- 質量濃度: \( C \) [mg/ml]
- ピクセル体積: \( V \) [µm³]

単位換算：
```
1 mg/ml = 1 mg/cm³ = 1 g/L = 10⁶ µg/cm³ = 1 pg/µm³
```

よって：
```
M_total [pg] = Σ C [mg/ml] × V [µm³]
```

### 5.3 実装

```python
# 各ピクセルの体積
pixel_volumes = thickness_um[mask] * pixel_area_um2  # [µm³]

# Total mass計算
total_mass_pg = np.sum(concentration_map[mask] * pixel_volumes)  # [pg]
```

### 5.4 物理的意味

- **pg（ピコグラム）**: 10⁻¹² g
- **典型的な細胞質量**: 数十〜数百 pg
- **時系列変化**: 細胞の成長、分裂、環境応答を定量

---

## 6. 使用した仮定

### 6.1 光学的仮定

1. **薄い物体近似（Thin Object Approximation）**
   - 光がサンプルを直進透過する
   - 回折・散乱の影響は無視

2. **均質な培地**
   - 培地の屈折率 \( n_{\text{medium}} \) は一定（1.333）
   - 温度・濃度変化は無視

3. **線形応答**
   - 位相差と光路長差が線形関係
   - 高次の非線形効果は無視

### 6.2 生物学的仮定

1. **比屈折率増分の一定性**
   - 細胞内のすべての領域で \( \alpha = 0.00018 \) ml/mg
   - タンパク質組成の違いは無視

2. **Rod-shaped形状モデル**
   - 細胞を円柱+半球でモデル化
   - 実際の形状からのずれは誤差要因

3. **2D投影からの3D再構成**
   - 楕円近似（Major, Minor, Angle）から3D形状を推定
   - Feret径近似も同様

### 6.3 数値計算上の仮定

1. **ピクセル離散化**
   - 連続的な物理量をピクセルで離散化
   - サブピクセルサンプリングで精度向上

2. **背景補正**
   - 1枚目の画像を全体から減算
   - 光学系の歪みは除去済みと仮定

---

## 7. パラメータ一覧

### 7.1 実験パラメータ

| パラメータ | 記号 | 値 | 単位 | 説明 |
|-----------|------|-----|------|------|
| レーザー波長 | λ | 663 | nm | オフアクシスホログラフィー用光源 |
| 培地屈折率 | n_medium | 1.333 | - | 培地（主に水）の屈折率 |
| ピクセルサイズ | - | 0.348 | µm | 507×507再構成画像のピクセルサイズ |
| 比屈折率増分 | α | 0.00018 | ml/mg | タンパク質の標準値 |

### 7.2 解析パラメータ

| パラメータ | 選択肢 | 説明 |
|-----------|--------|------|
| 形状近似 | `'ellipse'` / `'feret'` | 楕円 or Feret径 |
| サブピクセルサンプリング | `1` / `5` / `10` | ピクセル内分割数 |

### 7.3 物理定数

| 定数 | 値 | 説明 |
|------|-----|------|
| π | 3.14159... | 円周率 |
| c | 3×10⁸ m/s | 光速（真空中） |

---

## 8. 参考文献

### 8.1 QPI基礎

1. **Park, Y., Depeursinge, C. & Popescu, G.**  
   "Quantitative phase imaging in biomedicine."  
   *Nature Photonics* 12, 578–589 (2018).  
   DOI: 10.1038/s41566-018-0253-x

2. **Popescu, G.**  
   "Quantitative Phase Imaging of Cells and Tissues."  
   McGraw-Hill Education (2011).

### 8.2 屈折率と質量濃度

3. **Barer, R. & Joseph, S.**  
   "Refractometry of living cells."  
   *Quarterly Journal of Microscopical Science* 95, 399-423 (1954).

4. **Popescu, G. et al.**  
   "Optical imaging of cell mass and growth dynamics."  
   *American Journal of Physiology-Cell Physiology* 295, C538-C544 (2008).

5. **Mir, M. et al.**  
   "Optical measurement of cycle-dependent cell growth."  
   *Proceedings of the National Academy of Sciences* 108, 13124-13129 (2011).

### 8.3 比屈折率増分

6. **Davies, H. G. & Wilkins, M. H. F.**  
   "Interference microscopy and mass determination."  
   *Nature* 169, 541 (1952).

7. **Zhao, H., Brown, P. H. & Schuck, P.**  
   "On the distribution of protein refractive index increments."  
   *Biophysical Journal* 100, 2309-2317 (2011).

---

## 付録A: 単位換算表

### 長さ

| 単位 | 換算 |
|------|------|
| 1 m | 10⁶ µm = 10⁹ nm |
| 1 µm | 10⁻⁶ m = 10³ nm |
| 1 nm | 10⁻⁹ m = 10⁻³ µm |

### 体積

| 単位 | 換算 |
|------|------|
| 1 cm³ | 10⁻⁶ m³ = 10¹⁸ µm³ = 1 ml |
| 1 µm³ | 10⁻¹⁸ m³ = 10⁻¹⁵ cm³ |

### 質量

| 単位 | 換算 |
|------|------|
| 1 g | 10³ mg = 10¹² pg |
| 1 mg | 10⁻³ g = 10⁹ pg |
| 1 pg | 10⁻¹² g = 10⁻⁹ mg |

### 質量濃度

| 単位 | 換算 |
|------|------|
| 1 mg/ml | 1 mg/cm³ = 1 g/L = 1 pg/µm³ |

---

## 付録B: 計算フローチャート

```
┌─────────────────────┐
│ オフアクシス        │
│ ホログラム画像      │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ FFTによる位相再構成 │
│ → 位相差 φ [rad]    │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ ROI検出             │
│ (Omnipose)          │
│ → Major, Minor, θ   │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ 3D形状モデル        │
│ → 厚みマップ d(x,y) │
└──────┬──────────────┘
       │
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌──────────────┐      ┌───────────────┐
│ RI計算       │      │ 体積計算      │
│ n = n₀ +     │      │ V = Σ(d·A)    │
│  (φλ)/(2πd)  │      └───────┬───────┘
└──────┬───────┘              │
       │                      │
       ▼                      │
┌──────────────┐              │
│ 質量濃度計算 │              │
│ C = (n-n₀)/α │              │
└──────┬───────┘              │
       │                      │
       └──────────┬───────────┘
                  │
                  ▼
         ┌────────────────┐
         │ Total Mass計算 │
         │ M = Σ(C·V)     │
         └────────────────┘
```

---

## 付録C: エラー推定

### C.1 主要な誤差要因

1. **位相測定誤差**: ±0.01 rad（典型値）
2. **厚み推定誤差**: ±5%（形状モデル依存）
3. **α値の不確かさ**: ±10%（細胞内組成の違い）
4. **ピクセル離散化**: サブピクセルサンプリングで改善

### C.2 Total Massの誤差伝播

```
δM/M = sqrt[(δC/C)² + (δV/V)²]
     ≈ sqrt[(0.10)² + (0.05)²]
     ≈ 11%
```

---

**最終更新**: 2025-12-23  
**バージョン**: 1.0
